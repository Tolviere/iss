<!DOCTYPE html> 

<html lang="en"> 

<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Document</title> 
    <link rel="stylesheet" href="main-style.css"> 
</head> 

<body> 
    <div class="top-header"> 
        <h1>THE ISS</h1> 
        <ul> 
            <li><a href="index.html">home</a></li> 
            <li><a href="student-list.html">logs</a></li> 
        </ul> 
    </div> 

    <div class="transit-container"> 
        <div class="transit"> 
            <div class="circle"></div> 
            <p><b>Mafjslkdf wrei23</b> left <b>2:30</b> minutes ago from <b>Room 213</b></p> 
        </div> 

        <div class="transit"> 
            <div class="circle"></div> 
            <p><b>sdf wer2</b> left <b>5:21</b> minutes ago from <b>Room 218</b></p> 
        </div> 
    </div> 
</body> 

<script> 
    let current_id = 0 

    const transit_container = document.querySelector('.transit-container')     
    const green = 'rgb(120, 240, 120)'
    const yellow = 'rgb(254, 254, 67)'
    const red = 'rgb(230, 80, 80)'

    const responseAPI = async () => { 
        let names = await getData('http://localhost:3000/DATA-names') 
       // let roomNums = await getData('http://localhost:3000/DATA-room-nums') 
        let transits = await getData('http://localhost:3000/DATA-transit-going') 

        for (let i = current_id; i < transits.length; i++) { 
            let transit = document.createElement('div') 
            transit.classList.add('transit') 

            let student_name = names.find(nameDict => nameDict.student_id === transits[i].student_id); 
            if (!student_name) student_name = 'NAME' 
            else student_name = student_name.name 

            let room_num = transits[i].room
            if (!room_num) room_num = 'NOT FOUND' 

            let elapsed_time = Math.floor((new Date - new Date(transits[i].time)) / 1000)
            let mins = Math.floor(elapsed_time / 60)
            let secs = elapsed_time - mins * 60

            transit.setAttribute('data-mins', mins) 
            transit.setAttribute('data-secs', secs)
            transit.setAttribute('data-time', transits[i].time) 
            transit.setAttribute('data-student-id', transits[i].student_id) 
            transit.setAttribute('data-student-name', student_name) 
            transit.setAttribute('data-room-num', room_num) 

            let circle = document.createElement('div') 
            circle.classList.add('circle') 
            if (mins > 10) circle.style.backgroundColor = red
            else if (mins > 5) circle.style.backgroundColor = yellow

            transit.appendChild(circle) 

            let para = document.createElement('p') 
            para.innerHTML = await getOutString(student_name, transit.getAttribute('data-mins'), transit.getAttribute('data-secs'), room_num) 
            transit.appendChild(para) 

            transit_container.appendChild(transit) 

            current_id++ 
        } 

     //   setInterval(updateTime, 1000) 
        //setInterval(responseAPI, 1000) 
    } 

    async function getData(src) { 
        const res = await fetch(src) 
        const data = await res.json() 
        console.log(data)
        return data; 
    } 

    async function updateTime() { 
        let returned = await getData('http://localhost:3000/DATA-transit-returned') 
        returned.reverse() 

        transit_container.children.foreach(child => { 
            //let startingIndex = child.innerHTML.indexOf(child.data('data-mins')); 
            console.log('bruh')
            let timeElapsed = Math.floor((new Date - new Date(transits[i].time)) / 1000)
            let mins = Math.floor(elapsed_time / 60)
            let secs = elapsed_time - mins * 60
            child.innerHTML = getOutString(child.data('data-student-name'), mins, secs, child.data('data-room-num')) 

            let circle = child.querySelector('.circle') 
            if (mins > 10) circle.style.backgroundColor = red
            else if (mins > 5) circle.style.backgroundColor = yellow

            //if (child.data('data-mins')) 
            if(returned.find(log => log.student_id === child.data('data-student-id'))) { 
                transit_container.removeChild(child) 
            } 
        }) 
    } 

    async function getOutString(name, mins, secs, room) { 
        if (mins < 10) mins = `0${mins}`
        if (secs < 10) secs = `0${secs}`
        return `<b>${name}</b> left <b>${mins}:${secs}</b> minutes ago from <b>Room ${room}</b>` 
    } 

    responseAPI(); 

</script> 
</html> 

 